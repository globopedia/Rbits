<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√Årbitros ‚Äî Hurac√°n</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=MuseoModerno:wght@500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'MuseoModerno', sans-serif; background:#fff; color:#222; margin:20px; }
    h1 { color:#FF0000; text-align:center; }
    .logo { display:block; margin:0 auto 10px; width:100px; }
    select { padding:8px; border-radius:8px; border:2px solid #FF0000; font-size:16px; margin-bottom:20px; }
    .club-card { border:3px solid #FF0000; border-radius:20px; padding:20px; max-width:900px; margin:0 auto; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .club-header { display:flex; align-items:center; gap:15px; border-bottom:2px solid #FF0000; padding-bottom:10px; margin-bottom:10px; }
    h2 { margin:0; color:#FF0000; font-size:22px; }
    .stats { margin-top:20px; }
    .stat-group { margin-bottom:20px; padding:12px; border:1px solid #FF0000; border-radius:12px; background:#fff5f5; }
    .stat-title { font-weight:bold; color:#FF0000; margin-bottom:6px; }
    .hr { border:none; border-top:1px solid #FF0000; margin:8px 0; }
    .partido-card { border:1px solid #ccc; border-radius:6px; padding:6px; margin:4px 0; background:#fafafa; font-size:14px; text-align: center; }
    .acordeon { border: 1px solid #ddd; border-radius: 6px; margin: 6px 0; background: #fefefe; }
    .acordeon-header { background: #eee; padding: 4px 8px; cursor: pointer; font-size: 14px; text-align: right; position: relative; padding-right: 20px; }
    .acordeon-header::after { content: "‚ñæ"; position: absolute; right: 0; transition: transform 0.3s; }
    .acordeon-header.abierto::after { transform: rotate(180deg); }
    .acordeon-body { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease; padding: 8px; }
    .acordeon-body.cerrado { max-height: 0; padding: 0 8px; }
    .resultado1-box, .resultado2-box {
      display: inline-block; width: 16px; height: 28px; font-size: 32px; font-weight: bold;
      line-height: 28px; text-align: center; margin: 2px; padding: 10px 10px;
      border: 3px solid #FF0000; border-radius: 6px; background: #fff5f5;
      vertical-align: middle; min-width: 26px;
    }
    .escudo-huracan, .escudo-rival { width: 50px; height: 50px; object-fit: contain; position: relative; top: 6px; vertical-align: middle; }
    .resultado-con-escudo { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content:center; }
    .stat-title small { color:#666; font-weight:normal; margin-left:6px; }
  </style>
</head>
<body>
  <img src="https://globopedia.github.io/buscador-partidos/logo_globopedia.png" alt="Logo Hurac√°n" class="logo" />
  <h1>üìú √Årbitros</h1>

  <div style="text-align:center;">
    <label>Seleccionar juez: </label>
    <select id="arbitroSelect"></select>
  </div>

  <div id="arbitroInfo" class="club-card" style="display:none;"></div>

  <script>
    // URLs (cache buster)
    const arbitrosURL = "https://globopedia.github.io/Rbits/Rbits.csv?v=" + Date.now();
    const partidosURL = "https://globopedia.github.io/buscador-partidos/Encuentros_Huracan.csv?v=" + Date.now();

    let arbitros = [];
    let encuentros = [];

    // Utilidades
    const norm = (t) => (t || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();
    const cap = (s) => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : s;

    function bucketCompetencia(torneo) {
      const t = norm(torneo || "");
      if (t.includes("libertadores") || t.includes("conmebol") || t.includes("sudamericana")) return "Conmebol";
      if (t.includes("argentina") || t.includes("superliga") || t.includes("maradona") || t.includes("supercopa") || t.includes("nacional b") || t.includes("b nacional") || t.includes("campeonato")) return "AFA";
      if (t.includes("amistoso")) return "Amistosos";
      return "Otros";
    }

    const ORDEN_COMPETENCIAS = ["Conmebol","AFA","Amistosos","Otros"];
    const CONDICIONES = ["Local","Neutral","Visitante"];
    const SITUACIONES = ["Victoria","Empate","Derrota"];

    // Carga de CSVs
    Promise.all([
      fetch(arbitrosURL).then(r => { if(!r.ok) throw new Error("Rbits CSV no disponible"); return r.text(); }),
      fetch(partidosURL).then(r => { if(!r.ok) throw new Error("Partidos CSV no disponible"); return r.text(); })
    ])
    .then(([csvRbits, csvPartidos]) => {
      // Ajustar columnas seg√∫n tu CSV: ID, √Årbitro, Datos (tal como me pasaste)
      arbitros = Papa.parse(csvRbits, { header:true, skipEmptyLines:true }).data.map(c => ({
        id: (c.ID ?? "").toString().trim(),
        nombre: (c["√Årbitro"] ?? "").toString().trim(),
        datos: (c.Datos ?? "").toString().trim(),
        foto: (c.Foto ?? c.foto ?? "").toString().trim()
      }));

      encuentros = Papa.parse(csvPartidos, { header:true, skipEmptyLines:true }).data.map(p => ({
        Fecha: (p.Fecha ?? "").trim(),
        T√©cnico: (p.T√©cnico ?? "").trim(),
        Condici√≥n: (p.Condici√≥n ?? "").trim(),
        Situaci√≥n: (p.Situaci√≥n ?? "").trim(),
        Resultado1: (p.Resultado1 ?? "").trim(),
        Resultado2: (p.Resultado2 ?? "").trim(),
        Club: (p.Club ?? "").trim(),
        Torneo: (p.Torneo ?? "").trim(),
        Estadio: (p.Estadio ?? "").trim(),
        √Årbitro: (p.√Årbitro ?? "").trim(),
        Hurac√°n: (p.Hurac√°n ?? "").trim(),
        Rival: (p.Rival ?? "").trim(),
        Incidencias: (p.Incidencias ?? "").trim()
      }));

      llenarSelectArbitros();
    })
    .catch(err => {
      console.error("Error cargando CSVs:", err);
      alert("No pude cargar los CSV. Revis√° las URLs o el formato en la consola.");
    });

    // Mostrar apellido, nombre en el select (usa invertirNombre)
    function llenarSelectArbitros() {
      const sel = document.getElementById("arbitroSelect");
      sel.innerHTML = "<option value=''>-- Seleccionar --</option>";
      arbitros.forEach(a => {
        if (a.id && a.nombre) {
          const opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = invertirNombre(a.nombre);
          sel.appendChild(opt);
        }
      });
      sel.addEventListener("change", mostrarArbitro);
    }

    // Al seleccionar √°rbitro: mostrar datos + estad√≠sticas
    function mostrarArbitro() {
      const arbitroId = document.getElementById("arbitroSelect").value;
      const arbitro = arbitros.find(a => (a.id||"").trim() === (arbitroId||"").trim());
      if (!arbitro) {
        document.getElementById("arbitroInfo").style.display = "none";
        return;
      }

      const cont = document.getElementById("arbitroInfo");
      cont.style.display = "block";
      cont.innerHTML = `
        <div class="club-header">
          ${arbitro.foto ? `<img src="${arbitro.foto}" alt="${arbitro.nombre}" style="width:70px;height:70px;object-fit:cover;border-radius:8px;">` : ""}
          <h2>${arbitro.nombre}</h2>
        </div>
        <p><b>Datos:</b> ${arbitro.datos}</p>
        <div class="stats">
          <h3 style="color:#FF0000;">üìä Partidos arbitrados a Hurac√°n</h3>
          ${renderEstadisticas(arbitro.nombre)}
        </div>
      `;
    }

    // Render estadisticas por competencia y condici√≥n (genera checkboxes)
    function renderEstadisticas(nombreArbitro) {
      const delArbitro = encuentros.filter(p => norm(p.√Årbitro) === norm(nombreArbitro));
      const agg = {};
      for (const e of delArbitro) {
        const comp = bucketCompetencia(e.Torneo);
        const cond = cap(norm(e.Condici√≥n));
        const sit = cap(norm(e.Situaci√≥n));
        if (!agg[comp]) agg[comp] = {};
        if (!agg[comp][cond]) agg[comp][cond] = { Victoria:0, Empate:0, Derrota:0 };
        if (SITUACIONES.includes(sit)) {
          agg[comp][cond][sit] += 1;
        }
      }
      let html = "";
      for (const comp of ORDEN_COMPETENCIAS) {
        if (!agg[comp]) continue;
        let compHTML = "";
        CONDICIONES.forEach((cond, idx) => {
          const bucket = agg[comp][cond] || { Victoria:0, Empate:0, Derrota:0 };
          const tot = bucket.Victoria + bucket.Empate + bucket.Derrota;
          if (tot === 0) return;
          let bloque = `<div class="stat-title">üìç ${cond}</div><ul>`;
          ["Victoria","Empate","Derrota"].forEach(tipo => {
            const cantidad = bucket[tipo];
            if (cantidad > 0) {
              const icono = tipo==="Victoria"?"‚úÖ":tipo==="Empate"?"ü§ù":"‚ùå";
              bloque += `
                <li>
                  <label>
                    <input type="checkbox" class="chkPartidos" data-comp="${comp}" data-cond="${cond}" data-sit="${tipo}" data-arbitro="${nombreArbitro}">
                    ${icono} ${tipo}s: ${cantidad}
                  </label>
                  <div class="partidos-lista" style="display:none; margin-left:20px;"></div>
                </li>
              `;
            }
          });
          bloque += "</ul>";
          compHTML += bloque;
          if (idx < CONDICIONES.length - 1) compHTML += `<div class="hr"></div>`;
        });
        if (compHTML) {
          html += `
            <div class="stat-group">
              <div class="stat-title">üèÜ ${comp}</div>
              ${compHTML}
            </div>
          `;
        }
      }
      return html || "<p>Sin datos disponibles</p>";
    }

    // Manejador de checkboxes: muestra la lista de partidos seg√∫n filtro
    document.addEventListener("change", function(e) {
      if (!e.target.classList.contains("chkPartidos")) return;
      const contenedor = e.target.closest("li").querySelector(".partidos-lista");
      contenedor.innerHTML = "";
      if (e.target.checked) {
        const { comp, cond, sit, arbitro } = e.target.dataset;
        const partidos = encuentros.filter(p =>
          norm(p.√Årbitro) === norm(arbitro) &&
          bucketCompetencia(p.Torneo) === comp &&
          cap(norm(p.Condici√≥n)) === cond &&
          cap(norm(p.Situaci√≥n)) === sit
        );
        if (partidos.length) {
          partidos.forEach(p => {
            let bloqueHTML = "";
            // Si Hurac√°n fue visitante, lo mostramos en segundo lugar (resultado2)
            if ((p.Condici√≥n || "").toLowerCase() === "visitante") {
              bloqueHTML = `
                <div class="partido-card">
                  ${getTorneoImage(p.Torneo)}
                  <div class="resultado-con-escudo">
                    <img class="escudo-rival" src="${getEscudo(p.Club)}" alt="${p.Club}" />
                    <div class="resultado2-box">${p.Resultado2}</div>
                    <div class="resultado1-box">${p.Resultado1}</div>
                    <img class="escudo-huracan" src="${getEscudo('Hurac√°n')}" alt="Hurac√°n">
                  </div>
                  <div style="margin-top:6px;"><b>${p.Torneo}</b></div>
                  <div><b>Estadio:</b> ${p.Estadio} - <b>√Årbitro:</b> ${p.√Årbitro}</div>
                  <div style="margin-top:6px;">
                    ${ p.Estadio && getEstadioImage(p.Estadio)
                      ? `<img src="${getEstadioImage(p.Estadio)}" alt="${p.Estadio}" style="max-height:40px; display:block; margin:4px auto;">`
                      : "" }
                  </div>
                  <div style="margin-top:6px;"><b>${p.Club}:</b> ${p.Rival}</div>
                  <div><b>Hurac√°n:</b> ${p.Hurac√°n}</div>
                  <div style="margin-top:6px;">
                    ${ p.Estadio && getEstadioImage(p.Estadio)
                      ? `<img src="${getEstadioImage(p.Estadio)}" alt="${p.Estadio}" style="max-height:40px;">`
                      : `<b>Incidencias:</b>` }
                    ${renderIncidencias(p.Incidencias)}
                  </div>
                </div>
              `;
            } else {
              // Hurac√°n local (o neutral) ‚Äî Hurac√°n a la izquierda / primero
              bloqueHTML = `
                <div class="partido-card">
                  ${getTorneoImage(p.Torneo)}
                  <div class="resultado-con-escudo">
                    <img class="escudo-huracan" src="${getEscudo('Hurac√°n')}" alt="Hurac√°n">
                    <div class="resultado1-box">${p.Resultado1}</div>
                    <div class="resultado2-box">${p.Resultado2}</div>
                    <img class="escudo-rival" src="${getEscudo(p.Club)}" alt="${p.Club}" />
                  </div>
                  <div style="margin-top:6px;"><b>${p.Torneo}</b></div>
                  <div><b>Estadio:</b> ${p.Estadio} - <b>√Årbitro:</b> ${p.√Årbitro}</div>
                  <div style="margin-top:6px;">
                    ${ p.Estadio && getEstadioImage(p.Estadio)
                      ? `<img src="${getEstadioImage(p.Estadio)}" alt="${p.Estadio}" style="max-height:40px; display:block; margin:4px auto;">`
                      : "" }
                  </div>
                  <div style="margin-top:6px;"><b>Hurac√°n:</b> ${p.Hurac√°n}</div>
                  <div><b>${p.Club}:</b> ${p.Rival}</div>
                  <div style="margin-top:6px;">
                    ${ p.Estadio && getEstadioImage(p.Estadio)
                      ? `<img src="${getEstadioImage(p.Estadio)}" alt="${p.Estadio}" style="max-height:40px;">`
                      : `<b>Incidencias:</b>` }
                    ${renderIncidencias(p.Incidencias)}
                  </div>
                </div>
              `;
            }

            contenedor.innerHTML += `
              <div class="acordeon">
                <div class="acordeon-header">${p.Fecha}</div>
                <div class="acordeon-body cerrado">${bloqueHTML}</div>
              </div>
            `;
          });
        } else {
          contenedor.innerHTML = "<i>No hay partidos registrados</i>";
        }
        contenedor.style.display = "block";
      } else {
        contenedor.style.display = "none";
      }
    });

    // Toggle acorde√≥n
    document.addEventListener("click", function(e) {
      if (e.target.classList.contains("acordeon-header")) {
        const body = e.target.nextElementSibling;
        body.classList.toggle("cerrado");
        e.target.classList.toggle("abierto");
      }
    });

    // --- Funciones auxiliares que recuperan el formato original ---

    // Intenta obtener escudo construyendo la URL a la carpeta /escudos/
    function getEscudo(nombreClub) {
      if (!nombreClub) return "";
      // Primero intentamos con encoding (preserva acentos si los archivos est√°n as√≠)
      try {
        const file = encodeURIComponent(nombreClub.trim()) + ".png";
        return "https://globopedia.github.io/buscador-partidos/escudos/" + file;
      } catch (err) {
        // Fallback: eliminar acentos y espacios
        const fileName = nombreClub
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/\./g, "")
          .replace(/\s+/g, "") + ".png";
        return "https://globopedia.github.io/buscador-partidos/escudos/" + fileName;
      }
    }

    // Reemplaza tags de incidencias por iconos (GOL, EXP, ATA, PEN)
    function renderIncidencias(texto) {
      if (!texto) return "";
      return texto
        .replace(/GOL/g, "<img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgi3GyVjBR-e_IN4mWVAuZofChVOj763GApXwzanoEJDUTysF1K9gf3N5qBCoDJ-ahi8wRkrZ3FCbl0ovTEjXyjFjFEWYF1MZ7YvHrq0bD5eQ7GsJPOkpLSC-k4zpZ1CbnyKVtoYlb6JWXByKkd0VAHuN1hy8P9LBz2fhn5e3Um_X-m4U9WLo9pQP428Fj4/s320/GolR.png' alt='gol' style='width:20px;height:20px;margin-left:6px;'>")
        .replace(/EXP/g, "<img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgx8a6PCkGhKR9WTnh2NNWLMBDOIKWsNisSChpxN2NayjM5Z6YBIZmv52PvduZawIBBh_g5Pq56LdvjG8X1gSCud2q6NYS_NGOh7nAPaxUy_nC1YCcZJOgy2DeTZPRkqRgb1_HbpJshh-7o3MoW8Z3h8tBa8UZ153n5CzriOyvsSIxM6FsCbn-n115KC5Ln/s320/Roja.png' alt='expulsi√≥n' style='width:20px;height:20px;margin-left:6px;'>")
        .replace(/ATA/g, "<img src='https://blogger.googleusercontent.com/img/a/AVvXsEjygOwijhQ1dRIh6BPFrQu7EKOUShS0RLEVmPhCJSANGWOaNzvVmcbV03ZW0ZF5Npefl5r3P8iU6WjXRaSL80QYazspsJ4-nzA8pv4FqBwgu1Jr0wDw2iEPMvnVgK0nvRLeZmGYuVW8epSVTyyND28aoQRd9wD9yxKJWBuPOhOoVz-cUgpbM702W2ZlpsF7=w95-h79' alt='golh' style='width:20px;height:20px;margin-left:6px;'>")
        .replace(/PEN/g, "<img src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEho-erXGKkNZ7MaZWOtZw-ru0AnJwAlzHqnl5fKLmUAn_QtAMAbXgGMsqh21htJ2XSePyqAMAq4Xce1RkwkrqrA4Hw312mYcXhXMVW-m64vRS_lKTNgnBNvCzPZsPV3eEk_QclWiNZ9n9pvAQSiscTyp94vbN_h6aMeQ_nwTdBSdXGn5B3HW3A-sj_4Bw1j/s320/Penales.png' alt='pen' style='width:20px;height:20px;margin-left:6px;'>");
    }

    // Busca imagen de estadio en carpeta Estadios (con limpieza b√°sica del nombre)
    function getEstadioImage(estadio) {
      if (!estadio) return "";
      const fileName = estadio
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\./g, "")
        .replace(/\s+/g, "") + ".png";
      return "https://globopedia.github.io/buscador-partidos/Estadios/" + fileName;
    }

    // Intenta mostrar logo del torneo seg√∫n una lista conocida
    function getTorneoImage(nombreTorneo) {
      if (!nombreTorneo) return "";
      const texto = nombreTorneo.toLowerCase();
      const torneosDisponibles = [
        "Apertura 2007", "Clausura 2008", "Apertura 2008", "Clausura 2009",
        "Apertura 2009", "Clausura 2010", "Apertura 2010", "Clausura 2011",
        "Nacional B 11-12", "Copa Argentina 2012","Copa Argentina 2013","Copa Argentina 2014",
        "Copa Argentina 2015","Copa Argentina 2016","Copa Argentina 2017","Copa Argentina 2018",
        "Copa Argentina 2019","Copa Argentina 2020","Copa Argentina 2022","Copa Argentina 2023",
        "Copa Argentina 2024","Copa Argentina 2025", "Nacional B 12-13", "Nacional B 13-14",
        "Nacional B 2014", "Supercopa 2015", "Campeonato 2015", "Libertadores 2015",
        "Sudamericana 2015", "Campeonato 2016", "Libertadores 2016", "Campeonato 16-17",
        "Sudamericana 2017", "SAF 17-18", "SAF 18-19", "SAF 19-20", "Copa Maradona 2020",
        "Libertadores 2019", "Sudamericana 2020", "Torneo-LPF 2021", "Torneo-LPF 2022", "Torneo-LPF 2023",
        "Copa-LPF 2021", "Copa-LPF 2022", "Copa-LPF 2023", "Copa-LPF 2024", "Torneo-LPF 2024",
        "Apertura-LPF 2024", "Clausura-LPF 2025", "Libertadores 2023", "Sudamericana 2023", "Sudamericana 2025"
      ];
      for (const t of torneosDisponibles) {
        if (texto.includes(t.toLowerCase())) {
          const fileName = encodeURIComponent(t) + ".png";
          return `<img src="https://globopedia.github.io/buscador-partidos/Torneos/${fileName}" alt="${t}" style="max-height:40px; display:block; margin:4px auto;">`;
        }
      }
      return "";
    }

    // Invierte "Nombre Apellido (Extra)" -> "Apellido, Nombre (Extra)"
    function invertirNombre(nombre) {
      if (!nombre) return "";
      const match = nombre.match(/^(.*?)\s*\((.*?)\)$/);
      let base = nombre, extra = "";
      if (match) { base = match[1]; extra = " (" + match[2] + ")"; }
      const partes = base.trim().split(" ");
      if (partes.length < 2) return nombre;
      const apellido = partes.pop();
      const nombreSolo = partes.join(" ");
      return apellido + ", " + nombreSolo + extra;
    }

  </script>
</body>
</html>
