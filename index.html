<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√Årbitros</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=MuseoModerno:wght@500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'MuseoModerno', sans-serif; background:#fff; color:#222; margin:20px; }
    h1 { color:#FF0000; text-align:center; }
    .logo { display:block; margin:0 auto 10px; width:100px; }
    select { padding:8px; border-radius:8px; border:2px solid #FF0000; font-size:16px; margin-bottom:20px; }
    .club-card { border:3px solid #FF0000; border-radius:20px; padding:20px; max-width:900px; margin:0 auto; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .club-header { display:flex; align-items:center; gap:15px; border-bottom:2px solid #FF0000; padding-bottom:10px; margin-bottom:10px; }
    h2 { margin:0; color:#FF0000; font-size:22px; }
    .stats { margin-top:20px; }
    .stat-group { margin-bottom:20px; padding:12px; border:1px solid #FF0000; border-radius:12px; background:#fff5f5; }
    .stat-title { font-weight:bold; color:#FF0000; margin-bottom:6px; }
    .hr { border:none; border-top:1px solid #FF0000; margin:8px 0; }
    .partido-card { border:1px solid #ccc; border-radius:6px; padding:6px; margin:4px 0; background:#fafafa; font-size:14px; text-align: center; }
    .acordeon { border: 1px solid #ddd; border-radius: 6px; margin: 6px 0; background: #fefefe; }
    .acordeon-header { background: #eee; padding: 4px 8px; cursor: pointer; font-size: 14px; text-align: right; position: relative; padding-right: 20px; }
    .acordeon-header::after { content: "‚ñæ"; position: absolute; right: 0; transition: transform 0.3s; }
    .acordeon-header.abierto::after { transform: rotate(180deg); }
    .acordeon-body { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease; padding: 8px; }
    .acordeon-body.cerrado { max-height: 0; padding: 0 8px; }
    .resultado1-box, .resultado2-box {
      display: inline-block; width: 16px; height: 28px; font-size: 32px; font-weight: bold;
      line-height: 28px; text-align: center; margin: 2px; padding: 10px 10px;
      border: 3px solid #FF0000; border-radius: 6px; background: #fff5f5;
      vertical-align: middle; min-width: 26px;
    }
    .escudo-huracan, .escudo-rival { width: 50px; height: 50px; object-fit: contain; position: relative; top: 6px; vertical-align: middle; }
    .resultado-con-escudo { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <img src="https://globopedia.github.io/buscador-partidos/logo_globopedia.png" alt="Logo Hurac√°n" class="logo" />
  <h1>üìú √Årbitros</h1>
  <div style="text-align:center;">
    <label>Seleccionar juez: </label>
    <select id="arbitroSelect"></select>
  </div>
  <div id="arbitroInfo" class="club-card" style="display:none;"></div>

  <script>
    const arbitrosURL = "https://globopedia.github.io/Rbits/Rbits.csv?v=" + Date.now();
    const partidosURL = "https://globopedia.github.io/buscador-partidos/Encuentros_Huracan.csv?v=" + Date.now();
    let arbitros = [];
    let encuentros = [];

    // Normalizaciones
    const norm = (t) => (t || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();
    const cap = (s) => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : s;

    function bucketCompetencia(torneo) {
      const t = norm(torneo);
      if (t.includes("libertadores")) return "Copa Libertadores";
      if (t.includes("sudamericana")) return "Copa Sudamericana";
      if (t.includes("argentina")) return "Copa Argentina";
      if (t.includes("superliga")) return "Copa Superliga";
      if (t.includes("maradona")) return "Copa Maradona";
      if (t.includes("supercopa")) return "Supercopa";
      if (t.includes("b nacional") || t.includes("nacional b") || t.includes("nac b")) return "Nacional B";
      if (t.includes("campeonato") || t.includes("liga") || t.includes("torneo") || t.includes("primera")) return "Campeonato";
      if (t.includes("amistoso")) return "Amistoso";
      return "Otros";
    }

    const ORDEN_COMPETENCIAS = ["Copa Libertadores","Copa Sudamericana","Campeonato","Copa Argentina","Copa Superliga","Copa Maradona","Supercopa","Nacional B","Amistoso"];
    const CONDICIONES = ["Local","Neutral","Visitante"];
    const SITUACIONES = ["Victoria","Empate","Derrota"];

    // Cargar CSVs
    Promise.all([
      fetch(arbitrosURL).then(r => r.text()),
      fetch(partidosURL).then(r => r.text())
    ])
    .then(([csvRbits, csvPartidos]) => {
arbitros = Papa.parse(csvRbits, { header:true, skipEmptyLines:true }).data.map(c => ({
  id: (c.ID ?? "").toString().trim(),
  nombre: (c["√Årbitro"] ?? "").toString().trim(),
  datos: (c.Datos ?? "").toString().trim()
      }));
      
      encuentros = Papa.parse(csvPartidos, { header:true, skipEmptyLines:true }).data.map(p => ({
        Fecha: (p.Fecha ?? "").trim(),
        T√©cnico: (p.T√©cnico ?? "").trim(),
        Condici√≥n: (p.Condici√≥n ?? "").trim(),
        Situaci√≥n: (p.Situaci√≥n ?? "").trim(),
        Resultado1: (p.Resultado1 ?? "").trim(),
        Resultado2: (p.Resultado2 ?? "").trim(),
        Club: (p.Club ?? "").trim(),
        Torneo: (p.Torneo ?? "").trim(),
        Estadio: (p.Estadio ?? "").trim(),
        √Årbitro: (p.√Årbitro ?? "").trim(),
        Hurac√°n: (p.Hurac√°n ?? "").trim(),
        Rival: (p.Rival ?? "").trim(),
        Incidencias: (p.Incidencias ?? "").trim()
      }));

      llenarSelectArbitros();
    })
    .catch(err => {
      console.error("Error cargando CSVs:", err);
      alert("No pude cargar los CSV. Revis√° las URLs o el formato en la consola.");
    });

    function llenarSelectArbitros() {
      const sel = document.getElementById("arbitroSelect");
      sel.innerHTML = "<option value=''>-- Seleccionar --</option>";
      arbitros.forEach(a => {
        if (a.id && a.nombre) {
          const opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = a.nombre;
          sel.appendChild(opt);
        }
      });
      sel.addEventListener("change", mostrarArbitro);
    }

    function mostrarArbitro() {
      const arbitroId = document.getElementById("arbitroSelect").value;
      const arbitro = arbitros.find(a => (a.id||"").trim() === (arbitroId||"").trim());
      if (!arbitro) return;

      const cont = document.getElementById("arbitroInfo");
      cont.style.display = "block";
      cont.innerHTML = `
        <div class="club-header">
          <h2>${arbitro.nombre}</h2>
        </div>
        <p><b>Datos:</b> ${arbitro.datos}</p>
        <div class="stats">
          <h3 style="color:#FF0000;">üìä Partidos arbitrados a Hurac√°n</h3>
          ${renderEstadisticas(arbitro.nombre)}
        </div>
      `;
    }

    function renderEstadisticas(nombreArbitro) {
      const delArbitro = encuentros.filter(p => norm(p.√Årbitro) === norm(nombreArbitro));
      const agg = {};
      for (const e of delArbitro) {
        const comp = bucketCompetencia(e.Torneo);
        const cond = cap(norm(e.Condici√≥n));
        const sit = cap(norm(e.Situaci√≥n));
        if (!agg[comp]) agg[comp] = {};
        if (!agg[comp][cond]) agg[comp][cond] = { Victoria:0, Empate:0, Derrota:0 };
        if (SITUACIONES.includes(sit)) {
          agg[comp][cond][sit] += 1;
        }
      }
      let html = "";
      for (const comp of ORDEN_COMPETENCIAS) {
        if (!agg[comp]) continue;
        let compHTML = "";
        CONDICIONES.forEach((cond, idx) => {
          const bucket = agg[comp][cond] || { Victoria:0, Empate:0, Derrota:0 };
          const tot = bucket.Victoria + bucket.Empate + bucket.Derrota;
          if (tot === 0) return;
          let bloque = `<div class="stat-title">üìç ${cond}</div><ul>`;
          ["Victoria","Empate","Derrota"].forEach(tipo => {
            const cantidad = bucket[tipo];
            if (cantidad > 0) {
              const icono = tipo==="Victoria"?"‚úÖ":tipo==="Empate"?"ü§ù":"‚ùå";
              bloque += `
                <li>
                  <label>
                    <input type="checkbox" class="chkPartidos" data-comp="${comp}" data-cond="${cond}" data-sit="${tipo}" data-arbitro="${nombreArbitro}">
                    ${icono} ${tipo}s: ${cantidad}
                  </label>
                  <div class="partidos-lista" style="display:none; margin-left:20px;"></div>
                </li>
              `;
            }
          });
          bloque += "</ul>";
          compHTML += bloque;
          if (idx < CONDICIONES.length - 1) compHTML += `<div class="hr"></div>`;
        });
        if (compHTML) {
          html += `
            <div class="stat-group">
              <div class="stat-title">üèÜ ${comp}</div>
              ${compHTML}
            </div>
          `;
        }
      }
      return html || "<p>Sin datos disponibles</p>";
    }

    // Manejador de checkboxes
    document.addEventListener("change", function(e) {
      if (!e.target.classList.contains("chkPartidos")) return;
      const contenedor = e.target.closest("li").querySelector(".partidos-lista");
      contenedor.innerHTML = "";
      if (e.target.checked) {
        const { comp, cond, sit, arbitro } = e.target.dataset;
        const partidos = encuentros.filter(p =>
          norm(p.√Årbitro) === norm(arbitro) &&
          bucketCompetencia(p.Torneo) === comp &&
          cap(norm(p.Condici√≥n)) === cond &&
          cap(norm(p.Situaci√≥n)) === sit
        );
        if (partidos.length) {
          partidos.forEach(p => {
            contenedor.innerHTML += `
              <div class="acordeon">
                <div class="acordeon-header">${p.Fecha}</div>
                <div class="acordeon-body cerrado">
                  <div class="partido-card">
                    <div><b>${p.Torneo}</b></div>
                    <div><b>Condici√≥n:</b> ${p.Condici√≥n} - <b>Situaci√≥n:</b> ${p.Situaci√≥n}</div>
                    <div><b>Resultado:</b> Hurac√°n ${p.Resultado1} - ${p.Resultado2} ${p.Club}</div>
                    <div><b>Estadio:</b> ${p.Estadio}</div>
                    <div><b>Rival:</b> ${p.Rival}</div>
                    <div><b>Incidencias:</b> ${p.Incidencias}</div>
                  </div>
                </div>
              </div>
            `;
          });
        } else {
          contenedor.innerHTML = "<i>No hay partidos registrados</i>";
        }
        contenedor.style.display = "block";
      } else {
        contenedor.style.display = "none";
      }
    });

    // Toggle acorde√≥n
    document.addEventListener("click", function(e) {
      if (e.target.classList.contains("acordeon-header")) {
        const body = e.target.nextElementSibling;
        body.classList.toggle("cerrado");
        e.target.classList.toggle("abierto");
      }
    });
  </script>
</body>
</html>
